<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Ujian</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f0f4f8; }
    .header { background-color: #0066cc; color: white; padding: 15px; text-align: center; }
    .logo { display: block; margin: 0 auto; width: 100px; }
    .container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select { padding: 10px; margin: 8px 0; width: 100%; box-sizing: border-box; font-size: 16px; }
    input.duplicate { border: 2px solid red; background-color: #ffe6e6; }
    button { padding: 10px 20px; margin: 10px auto; display: block; font-size: 16px; cursor: pointer; }
    .form-group { margin-bottom: 15px; }
    .error { color: red; font-size: 14px; text-align: center; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; word-wrap: break-word; }
    th { background-color: #f4f4f4; }
    .filter-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .filter-row select, .filter-row button { flex: 1; min-width: 150px; }
    .footer { text-align: center; margin-top: 30px; color: #555; font-size: 14px; }
    @media (max-width: 600px) { table, th, td { font-size: 12px; } }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://github.com/smp2pajangan/loginujian/blob/main/logosmpn2pjg.png?raw=true" class="logo" alt="Logo">
    <h2>SMP NEGERI 2 PAJANGAN</h2>
  </div>

  <div class="container" id="loginSection">
    <h3 style="text-align: center;">LOGIN ADMINISTRASI</h3>
    <input type="text" id="username" placeholder="Masukan Username (admin)" />
    <input type="password" id="password" placeholder="Masukan Password" />
    <button onclick="login()">Login</button>
    <p id="loginError" class="error"></p>
  </div>

  <div class="container" id="adminPanel" style="display:none;">
    <button onclick="logout()">Logout</button>
    <h3>Tambah / Edit Token</h3>
    <form id="tokenForm">
      <div class="form-group"><input type="text" id="subject" placeholder="Mata Pelajaran" required /></div>
      <div class="form-group"><input type="text" id="kelas" placeholder="Kelas" required pattern="\\d+" title="Hanya angka" /></div>
      <div class="form-group"><input type="text" id="token" placeholder="Token Ujian" required /></div>
      <div class="form-group"><input type="url" id="url" placeholder="Link Ujian" required /></div>
      <div class="form-group">
        <label>Tanggal Mulai</label>
        <input type="datetime-local" id="startTime" required />
      </div>
      <div class="form-group">
        <label>Tanggal Selesai</label>
        <input type="datetime-local" id="endTime" required />
      </div>
      <button type="submit">Simpan</button>
      <p id="errorMsg" class="error"></p>
    </form>

    <div class="filter-row">
      <select id="filterKelas"><option value="">Semua Kelas</option></select>
      <select id="filterMapel"><option value="">Semua Mapel</option></select>
      <button onclick="exportPDF()">Export PDF</button>
    </div>

    <h3>Daftar Token</h3>
    <table>
      <thead>
        <tr>
          <th>No</th><th>Mapel</th><th>Kelas</th><th>Token</th><th>Link</th><th>Mulai</th><th>Selesai</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tokenTableBody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div>@admin smpn 2 pajangan</div>
    <div id="clock"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const firebaseConfig = { /* ... your firebase config ... */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ADMIN_USER = "admin";
    const ADMIN_PASS = "12345";
    let currentTokenId = null;
    let tokenCache = [];

    window.login = function () { /* ... login logic ... */ };
    window.logout = function () { /* ... logout logic ... */ };

    function loadTokens() { /* ... load token from Firebase ... */ }
    function renderTokens(data) { /* ... render tokens to table ... */ }
    function updateFilterOptions(kelasSet, mapelSet) { /* ... filter logic ... */ }

    document.getElementById('filterKelas').addEventListener('change', filterTokens);
    document.getElementById('filterMapel').addEventListener('change', filterTokens);

    function filterTokens() { /* ... filtering tokens ... */ }
    window.hapusToken = function(id) { /* ... hapus token logic ... */ };

    document.getElementById('subject').addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase();
    });
    document.getElementById('token').addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase();
    });

    document.getElementById('tokenForm').addEventListener('submit', function(e) {
      e.preventDefault();
      // ... ambil value dan simpan ke Firebase ...
    });

    window.exportPDF = function () {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
      const marginLeft = 10;
      let y = 20;

      doc.setFontSize(14);
      doc.text("Daftar Token Ujian", marginLeft, y);
      y += 10;

      const headers = ["No", "Mapel", "Kelas", "Token", "Link", "Mulai", "Selesai"];
      const colWidths = [10, 30, 15, 25, 40, 35, 35];
      const cellHeight = 8;

      let x = marginLeft;
      doc.setFontSize(10);
      headers.forEach((header, i) => {
        doc.rect(x, y, colWidths[i], cellHeight);
        doc.text(header, x + 1.5, y + 5);
        x += colWidths[i];
      });
      y += cellHeight;

      tokenCache.forEach((t, i) => {
        if (y + cellHeight > 287) {
          doc.addPage();
          y = 20;
          x = marginLeft;
          headers.forEach((header, i) => {
            doc.rect(x, y, colWidths[i], cellHeight);
            doc.text(header, x + 1.5, y + 5);
            x += colWidths[i];
          });
          y += cellHeight;
        }

        const row = [
          (i + 1).toString(), t.subject, t.kelas, t.token, t.url, t.startTime, t.endTime
        ];
        x = marginLeft;
        row.forEach((cell, j) => {
          doc.rect(x, y, colWidths[j], cellHeight);
          const cellText = doc.splitTextToSize(cell, colWidths[j] - 2);
          doc.text(cellText, x + 1.5, y + 5);
          x += colWidths[j];
        });
        y += cellHeight;
      });

      doc.save("daftar_token.pdf");
    };

    function updateClock() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = now.toLocaleDateString('id-ID', options);
      const timeStr = now.toLocaleTimeString('id-ID');
      document.getElementById('clock').innerText = `${dateStr} - ${timeStr}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
