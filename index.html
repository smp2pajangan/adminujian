<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOBCX8x60pYqxtXmXMz2xc5dwC3HJH5EE",
    authDomain: "ujian-online-berbasis-android.firebaseapp.com",
    databaseURL: "https://ujian-online-berbasis-android-default-rtdb.firebaseio.com",
    projectId: "ujian-online-berbasis-android",
    storageBucket: "ujian-online-berbasis-android.appspot.com",
    messagingSenderId: "923446282537",
    appId: "1:923446282537:web:60d374dde8aca61f6a0f38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const ADMIN_USER = "admin";
  const ADMIN_PASS = "12345";
  let currentTokenId = null;
  let tokenCache = [];

  window.login = function() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if (username === ADMIN_USER && password === ADMIN_PASS) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadTokens();
    } else {
      document.getElementById("loginError").innerText = "Username atau password salah.";
    }
  };
function loadTokens() {
    onValue(ref(db, 'tokens'), (snapshot) => {
      const tbody = document.getElementById('tokenTableBody');
      tbody.innerHTML = '';
      tokenCache = [];

      snapshot.forEach(child => {
        const data = child.val();
        data.key = child.key;
        tokenCache.push(data);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${tokenCache.length}</td>
          <td>${data.subject}</td>
          <td>${data.kelas}</td>
          <td>${data.token}</td>
          <td><a href="${data.url}" target="_blank">Link</a></td>
          <td>${data.startTime}</td>
          <td>${data.endTime}</td>
          <td>
            <button onclick="editToken('${data.key}')">Edit</button>
            <button onclick="promptDelete('${data.key}')">Hapus</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  document.getElementById('tokenForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const subject = document.getElementById('subject').value.trim();
    const kelas = document.getElementById('kelas').value.trim();
    const token = document.getElementById('token').value.trim();
    const url = document.getElementById('url').value.trim();
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const errorMsg = document.getElementById('errorMsg');

    if (!subject || !kelas || !token || !url || !startTime || !endTime) {
      errorMsg.innerText = "Semua field harus diisi!";
      return;
    }

    const isTokenDup = tokenCache.some(t => t.key !== currentTokenId && t.token === token);
    const isUrlDup = tokenCache.some(t => t.key !== currentTokenId && t.url === url);
    if (isTokenDup || isUrlDup) {
      errorMsg.innerText = "Token atau URL sudah ada!";
      return;
    }

    errorMsg.innerText = "";
    const tokenData = { subject, kelas, token, url, startTime, endTime };
    if (currentTokenId) {
      update(ref(db, 'tokens/' + currentTokenId), tokenData);
      currentTokenId = null;
    } else {
      push(ref(db, 'tokens'), tokenData);
    }

    this.reset();
    loadTokens();
  });

// Buka Modal Edit
  window.editToken = function(id) {
    const token = tokenCache.find(t => t.key === id);
    currentTokenId = id;
    document.getElementById('editSubject').value = token.subject;
    document.getElementById('editKelas').value = token.kelas;
    document.getElementById('editToken').value = token.token;
    document.getElementById('editUrl').value = token.url;
    document.getElementById('editStartTime').value = token.startTime;
    document.getElementById('editEndTime').value = token.endTime;
    document.getElementById('editModal').style.display = 'flex';
  };

  // Simpan Edit Token dengan Validasi Unik
  document.getElementById('modalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const updatedToken = document.getElementById('editToken').value.trim();
    const updatedUrl = document.getElementById('editUrl').value.trim();

    const isDupToken = tokenCache.some(t => t.key !== currentTokenId && t.token === updatedToken);
    const isDupUrl = tokenCache.some(t => t.key !== currentTokenId && t.url === updatedUrl);

    if (isDupToken || isDupUrl) {
      alert("Token atau URL sudah digunakan oleh data lain.");
      return;
    }

    const updated = {
      subject: document.getElementById('editSubject').value.trim(),
      kelas: document.getElementById('editKelas').value.trim(),
      token: updatedToken,
      url: updatedUrl,
      startTime: document.getElementById('editStartTime').value,
      endTime: document.getElementById('editEndTime').value
    };

    update(ref(db, 'tokens/' + currentTokenId), updated);
    closeEditModal();
    loadTokens();
  });

  window.closeEditModal = function() {
    document.getElementById('editModal').style.display = 'none';
    currentTokenId = null;
  };

// Delete Token - tampilkan modal konfirmasi
  let deleteId = null;
  window.promptDelete = function(id) {
    deleteId = id;
    document.getElementById('deleteModal').style.display = 'flex';
  };

  // Konfirmasi hapus
  window.confirmDelete = function() {
    if (deleteId) {
      remove(ref(db, 'tokens/' + deleteId));
      deleteId = null;
      closeDeleteModal();
      loadTokens();
    }
  };

  window.closeDeleteModal = function() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteId = null;
  };

  // Realtime Jam & Tanggal
  function updateTime() {
    const now = new Date();
    const tanggal = now.toLocaleDateString('id-ID', {
      weekday: 'long',
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    });
    const waktu = now.toLocaleTimeString('id-ID', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    const display = `${tanggal} | ${waktu}`;
    document.getElementById("currentTime").innerText = display;
    document.getElementById("adminDateTime").innerText = display;
  }

  setInterval(updateTime, 1000);
  updateTime();
</script>
</body>
</html>